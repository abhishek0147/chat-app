<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC2CgKMqAqIc2_LsmLv7h9SeGH_P3iY3Lw",
    authDomain: "chat-app-b8150.firebaseapp.com",
    databaseURL: "https://chat-app-b8150-default-rtdb.firebaseio.com",
    projectId: "chat-app-b8150",
    storageBucket: "chat-app-b8150.appspot.com",
    messagingSenderId: "558501909388",
    appId: "1:558501909388:web:3bc5aece4f56cd7d43fca9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const provider = new firebase.auth.GoogleAuthProvider();

  const welcomeScreen = document.querySelector(".welcome-screen");
  const authScreen = document.querySelector(".auth-screen");
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const registerScreen = document.querySelector(".register-screen");
  const registerForm = document.getElementById("register-form");
  const chatScreen = document.querySelector(".chat-screen");
  const input = document.getElementById("input");
  const messages = document.getElementById("messages");
  const themeToggle = document.getElementById("theme-toggle");
  const leaveBtn = document.getElementById("leave-btn");
  const clearChatBtn = document.getElementById("clear-chat");
  const userCount = document.getElementById("user-count");
  const chatRoomDisplay = document.getElementById("chat-room");
  const typingIndicator = document.getElementById("typing-indicator");
  const sendButton = document.getElementById("send-button");
  let user = null;
  let room = "main";
  let roomRef, typingRef, usersRef, thisUserRef;
  const adminEmail = "your-admin-email@gmail.com"; // change to your real admin email

  // Switch form logic
  document.getElementById("show-signup").onclick = e => {
    e.preventDefault();
    loginForm.style.display = "none";
    signupForm.style.display = "block";
  };
  document.getElementById("show-login").onclick = e => {
    e.preventDefault();
    signupForm.style.display = "none";
    loginForm.style.display = "block";
  };

  document.getElementById("google-login").onclick = () => {
    auth.signInWithPopup(provider).catch(e => {
      alert("Google sign-in failed: " + e.message);
    });
  };

  // Initial welcome message
  setTimeout(() => {
    welcomeScreen.style.display = "none";
    authScreen.style.display = "flex";
  }, 2000);

  // Auth State
  auth.onAuthStateChanged(u => {
    if (u) {
      user = u;
      authScreen.style.display = "none";
      registerScreen.style.display = "flex";
      chatScreen.style.display = "none";
    } else {
      authScreen.style.display = "flex";
      registerScreen.style.display = "none";
      chatScreen.style.display = "none";
    }
  });

  // Login
  loginForm.addEventListener("submit", e => {
    e.preventDefault();
    const email = document.getElementById("login-email").value;
    const pass = document.getElementById("login-password").value;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => document.getElementById("login-error").innerText = e.message);
  });

  // Signup
  signupForm.addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("signup-name").value;
    const email = document.getElementById("signup-email").value;
    const pass = document.getElementById("signup-password").value;
    auth.createUserWithEmailAndPassword(email, pass).then(cred => {
      return cred.user.updateProfile({ displayName: name });
    }).catch(e => document.getElementById("signup-error").innerText = e.message);
  });

  // Room Join
  registerForm.addEventListener("submit", e => {
    e.preventDefault();
    room = document.getElementById("reg-room").value.trim().toLowerCase() || "main";
    registerScreen.style.display = "none";
    chatScreen.style.display = "flex";
    chatRoomDisplay.textContent = `Room: ${room}`;

    roomRef = db.ref(`rooms/${room}/messages`);
    typingRef = db.ref(`rooms/${room}/typing`);
    usersRef = db.ref(`rooms/${room}/onlineUsers`);
    thisUserRef = usersRef.child(user.uid);
    thisUserRef.set(user.displayName || user.email);
    thisUserRef.onDisconnect().remove();

    messages.innerHTML = "";
    roomRef.off();
    roomRef.limitToLast(100).on("child_added", snap => {
      const msg = snap.val();
      const li = document.createElement("li");
      li.className = msg.system ? "system-msg" : "user-msg";
      li.innerHTML = msg.system
        ? `<em>${msg.message}</em>`
        : `<strong>${msg.username}</strong>: ${msg.message} <span style="color:#aaa; font-size:0.8em;">${msg.time}</span>`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    usersRef.on("value", snap => {
      const val = snap.val();
      userCount.innerText = val ? Object.keys(val).length : 0;
    });

    usersRef.on("child_removed", snap => {
      const leftUser = snap.val();
      roomRef.push({ system: true, message: `ðŸšª ${leftUser} left.`, time: getTime() });
    });

    roomRef.push({ system: true, message: `ðŸ”” ${user.displayName || user.email} joined.`, time: getTime() });
    clearChatBtn.style.display = (user.email === adminEmail) ? "inline-block" : "none";
  });

  // Send Text Message
  document.getElementById("form").addEventListener("submit", e => {
    e.preventDefault();
    const msg = input.value.trim();
    if (!msg) return;
    roomRef.push({
      username: user.displayName || user.email,
      message: msg,
      time: getTime()
    });
    input.value = "";
    typingRef.set(null);
  });

  // Emoji Buttons Send Instantly
  document.querySelectorAll(".emoji-button").forEach(btn => {
    btn.addEventListener("click", () => {
      const emoji = btn.dataset.emoji;
      roomRef.push({
        username: user.displayName || user.email,
        message: emoji,
        time: getTime()
      });
      input.value = "";
      typingRef.set(null);
    });
  });

  input.addEventListener("input", () => {
    typingRef.set(user.displayName || user.email);
    setTimeout(() => {
      if (!input.value) typingRef.set(null);
    }, 1000);
  });

  leaveBtn.addEventListener("click", () => {
    roomRef.push({ system: true, message: `ðŸšª ${user.displayName || user.email} left.`, time: getTime() });
    thisUserRef.remove();
    chatScreen.style.display = "none";
    registerScreen.style.display = "flex";
  });

  clearChatBtn.addEventListener("click", () => {
    if (confirm("Clear all messages in this room?")) {
      roomRef.remove();
      messages.innerHTML = "";
    }
  });

  themeToggle.addEventListener("click", () => {
    const dark = document.body.classList.toggle("dark");
    localStorage.setItem("dark-mode", dark);
    themeToggle.textContent = dark ? "ðŸŒ™" : "ðŸŒž";
  });

  document.addEventListener("DOMContentLoaded", () => {
    const dark = localStorage.getItem("dark-mode") === "true";
    document.body.classList.toggle("dark", dark);
    themeToggle.textContent = dark ? "ðŸŒ™" : "ðŸŒž";
  });

  function getTime() {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }
</script>
