<script src="/socket.io/socket.io.js"></script>
<script>
  const registerScreen = document.getElementById('register-screen');
  const chatScreen = document.getElementById('chat-screen');
  const registerForm = document.getElementById('register-form');
  const regUsername = document.getElementById('reg-username');
  const regRoom = document.getElementById('reg-room');
  const chatRoomName = document.getElementById('chat-room-name');
  const chatUsername = document.getElementById('chat-username');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const messages = document.getElementById('messages');

  let username = '';
  let room = '';
  let socket = null;

  // Register submit event
  registerForm.addEventListener('submit', (e) => {
    e.preventDefault();

    username = regUsername.value.trim();
    room = regRoom.value.trim().replace(/\s+/g, '_') || 'main';

    if (!username) {
      alert("Please enter a username");
      return;
    }

    // Hide register, show chat
    registerScreen.style.display = "none";
    chatScreen.style.display = "flex";
    chatUsername.textContent = `User: ${username}`;
    chatRoomName.textContent = `Room: ${room}`;

    // Connect socket
    socket = io();
    socket.emit('joinRoom', { username, room });

    // Attach form submit inside the event listener to ensure it exists
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      if (input.value && socket) {
        const trimmed = input.value.trim();
        if (trimmed.length > 0) {
          socket.emit('chat message', { message: trimmed });
        }
        input.value = '';
      }
    });

    socket.on('chat message', function(msg) {
      const item = document.createElement('li');

      if (msg.system) {
        item.textContent = msg.message;
        item.className = "system-msg";
      } else {
        item.innerHTML = `<span class="msg-username">${msg.username || "anon"}:</span> 
                          <span class="msg-content">${msg.message}</span> 
                          <span class="msg-time">${msg.time || ''}</span>`;
      }

      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });
  });
</script>
