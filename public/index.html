<script src="/socket.io/socket.io.js"></script>
<script>
  const registerForm = document.getElementById('register-form');
  const regScreen = document.getElementById('register-screen');
  const chatScreen = document.getElementById('chat-screen');
  const chatHeaderRoom = document.getElementById('chat-room-name');
  const chatHeaderUsername = document.getElementById('chat-username');
  const messages = document.getElementById('messages');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  let socket;

  registerForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const usernameInput = document.getElementById('reg-username').value.trim();
    const roomInput = document.getElementById('reg-room').value.trim() || 'main';

    if (!usernameInput) {
      alert('Enter a valid username');
      return;
    }

    regScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    chatHeaderUsername.textContent = 'User: ' + usernameInput;
    chatHeaderRoom.textContent = 'Room: ' + roomInput;

    socket = io();

    socket.emit('joinRoom', {
      username: usernameInput,
      room: roomInput
    });

    socket.on('chat message', (msg) => {
      const li = document.createElement('li');

      if (msg.system) {
        li.textContent = msg.message;
        li.className = "system-msg";
      } else {
        li.innerHTML = `<strong>${msg.username}</strong>: ${msg.message} <span class="time">${msg.time}</span>`;
      }

      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      const text = input.value.trim();
      if (text) {
        socket.emit('chat message', { message: text });
        input.value = '';
      }
    });
  });
</script>
