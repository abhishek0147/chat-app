<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Chat App</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="auth-screen" style="display:flex;">
    <div class="auth-box">
      <h2>Sign in to Chat</h2>
      <button id="google-auth-btn" type="button">Sign in with Google</button>
      <div style="margin: 10px 0; color: #888;">or</div>
      <button id="anon-auth-btn" type="button">Continue Anonymously</button>
    </div>
  </div>

  <div class="register-screen" style="display:none;">
    <form id="register-form">
      <h2>Join Room</h2>
      <input id="reg-room" placeholder="Room (default: main)" />
      <button type="submit">Enter Chat Room</button>
    </form>
  </div>

  <div class="chat-screen" style="display:none;">
    <div class="chat-header">
      <span id="chat-room"></span>
      <span id="chat-username"></span>
      <span id="user-presence" style="margin-left:20px;color:#53bb63;font-size:0.95em;"></span>
      <button id="signout-btn" type="button" style="float:right;background: #ff7182;">Sign Out</button>
    </div>
    <ul id="messages"></ul>
    <form id="form" autocomplete="off">
      <input id="input" placeholder="Type your message..." />
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2CgKMqAqIc2_LsmLv7h9SeGH_P3iY3Lw",
      authDomain: "chat-app-b8150.firebaseapp.com",
      databaseURL: "https://chat-app-b8150-default-rtdb.firebaseio.com",
      projectId: "chat-app-b8150",
      storageBucket: "chat-app-b8150.appspot.com",
      messagingSenderId: "558501909388",
      appId: "1:558501909388:web:3bc5aece4f56cd7d43fca9",
      measurementId: "G-8S9BHZ9R0X"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
  </script>
  <script>
    // ===== UI Elements =====
    const authScreen = document.querySelector(".auth-screen");
    const registerScreen = document.querySelector(".register-screen");
    const chatScreen = document.querySelector(".chat-screen");
    const registerForm = document.getElementById("register-form");
    const roomInput = document.getElementById("reg-room");
    const chatRoomDisplay = document.getElementById("chat-room");
    const chatUsernameDisplay = document.getElementById("chat-username");
    const userPresenceDisplay = document.getElementById("user-presence");
    const messageForm = document.getElementById("form");
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const signoutBtn = document.getElementById("signout-btn");
    //
    let user, room, roomRef, roomPresenceRef, messagesListener, presenceListener;

    // -- AUTH --
    document.getElementById("google-auth-btn").onclick = function () {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(e => alert(e.message));
    };
    document.getElementById("anon-auth-btn").onclick = function () {
      firebase.auth().signInAnonymously().catch(e => alert(e.message));
    };
    signoutBtn.onclick = function() {
      if (user && room && roomPresenceRef) roomPresenceRef.child(user.uid).remove();
      auth.signOut();
      location.reload();
    };

    auth.onAuthStateChanged(function(u) {
      if (u) {
        user = u;
        authScreen.style.display = 'none';
        registerScreen.style.display = 'flex';
        chatUsernameDisplay.textContent = "User: " + (
          u.displayName || u.email || "Anonymous"
        );
      } else {
        authScreen.style.display = 'flex';
        registerScreen.style.display = chatScreen.style.display = 'none';
      }
    });

    // -- JOIN ROOM --
    registerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      room = roomInput.value.trim() || "main";
      registerScreen.style.display = "none";
      chatScreen.style.display = "flex";
      chatRoomDisplay.textContent = "Room: " + room;
      chatUsernameDisplay.textContent = "User: " + (
        user.displayName || user.email || "Anonymous"
      );
      roomRef = db.ref(`rooms/${room}/messages`);
      roomPresenceRef = db.ref(`rooms/${room}/presence`);
      messages.innerHTML = "";
      // Presence
      updatePresence();
      listenPresence();
      // Chat
      listenMessages();
      // System join message
      roomRef.push({
        system: true,
        message: `üîî ${chatUsernameDisplay.textContent} joined the room.`,
        time: new Date().toLocaleTimeString()
      });
    });

    // -- SEND MESSAGE --
    messageForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (text && user && roomRef) {
        roomRef.push({
          username: user.displayName || user.email || "Anonymous",
          userUid: user.uid,
          message: text,
          time: new Date().toLocaleTimeString()
        });
        input.value = "";
      }
    });

    // -- PRESENCE --
    function updatePresence() {
      if (user && room && roomPresenceRef) {
        const presenceRef = roomPresenceRef.child(user.uid);
        presenceRef.set({
          displayName: user.displayName || user.email || "Anonymous",
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
        presenceRef.onDisconnect().remove();
      }
    }
    function listenPresence() {
      if (presenceListener && typeof presenceListener === "function") {
        roomPresenceRef.off("value", presenceListener);
      }
      presenceListener = roomPresenceRef.on("value", snap => {
        const users = [];
        snap.forEach(child => users.push(child.val().displayName));
        userPresenceDisplay.textContent =
          users.length ?
            `${users.length} online: ${users.join(", ")}` :
            "No users online";
      });
    }

    // -- REALTIME CHAT --
    function listenMessages() {
      if (messagesListener && typeof messagesListener === "function") {
        roomRef.off("child_added", messagesListener);
        roomRef.off("child_changed", messagesListener);
        roomRef.off("child_removed", messagesListener);
      }
      messages.innerHTML = "";
      messagesListener = function (snap) {
        const msg = snap.val();
        const li = document.createElement("li");
        li.setAttribute("data-key", snap.key);
        // Edit/Delete btns
        if (!msg.system && msg.userUid === user.uid) {
          // Delete
          const delBtn = document.createElement("button");
          delBtn.textContent = "üóëÔ∏è";
          delBtn.className = "msg-btn";
          delBtn.title = "Delete";
          delBtn.onclick = function() {
            if (confirm("Delete this message?")) roomRef.child(snap.key).remove();
          };
          li.appendChild(delBtn);
          // Edit
          const editBtn = document.createElement("button");
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.className = "msg-btn";
          editBtn.title = "Edit";
          editBtn.onclick = function() {
            const newMsg = prompt("Edit your message:", msg.message);
            if (newMsg && newMsg.trim() !== "") {
              roomRef.child(snap.key).update({message: newMsg, edited: true});
            }
          };
          li.appendChild(editBtn);
        }
        // Message display
        if (msg.system) {
          li.className = "system-msg";
          li.textContent = msg.message;
        } else {
          li.innerHTML +=
            `<strong>${msg.username}</strong>: ${msg.message.replace(/</g,"&lt;")}
             <span class="msg-time">${msg.time || ""}${msg.edited ? " (edited)" : ""}</span>`;
        }
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      };
      // Listen add, edit, remove
      roomRef.limitToLast(50).on("child_added", messagesListener);
      roomRef.on("child_changed", function(snap) {
        const li = messages.querySelector(`[data-key="${snap.key}"]`);
        if (li) {
          const msg = snap.val();
          li.innerHTML = '';
          if (!msg.system && msg.userUid === user.uid) {
            // Delete
            const delBtn = document.createElement("button");
            delBtn.textContent = "üóëÔ∏è";
            delBtn.className = "msg-btn";
            delBtn.title = "Delete";
            delBtn.onclick = function() {
              if (confirm("Delete this message?")) roomRef.child(snap.key).remove();
            };
            li.appendChild(delBtn);
            // Edit
            const editBtn = document.createElement("button");
            editBtn.textContent = "‚úèÔ∏è";
            editBtn.className = "msg-btn";
            editBtn.title = "Edit";
            editBtn.onclick = function() {
              const newMsg = prompt("Edit your message:", msg.message);
              if (newMsg && newMsg.trim() !== "") {
                roomRef.child(snap.key).update({message: new
